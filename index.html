<!doctype html>
<html>
    <head>
        <title>UMD Class Checker</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" rel="text/css" href="style.css">
    </head>
    <body onload="onLoad()">
        <div id="top">
            <h1><b>UMD Class Checker</b></h1>
        </div>
        
        <br>
        
        <div id="Spring2022" class="semesterDiv mx-auto">
            <p class="lead SemesterString">Spring 2022</p>
            <table class="table table-striped table-bordered text-center ScheduleTable">
                <thead>
                    <tr>
                        <th scope="col">Class Code</th>
                        <th scope="col">Section</th>
                        <th scope="col">Total Seats</th>
                        <th scope="col">Open Seats</th>
                        <th scope="col">Taken Seats</th>
                        <th scope="col">Percent Full</th>
                        <th scope="col">Progress Bar</th>
                        <th scope="col">Remove</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        
        <br>
        
        <div id="form" class="mx-auto">
            <p class="text-center h5">Insert New Class</p>
            <form class="text-center">
                <div id="classEntry">
                    <label for="classCode">Class: </label>
                    <input type="text" id="classCodeInput" name="classCode" size="9">
                </div>
                <div id="sectionEntry">
                    <label for="section">Section: </label>
                    <input type="text" id="sectionInput" name="section" maxlength="4" size="4">
                </div>
                <br><br>
                <input onclick="formSubmit()" type= "button" value="Submit">
            </form>
        </div>
        
        <br><br>
        
        <footer class="text-center">
            <p class="small">A tool by Dylan Speiser</p>
            <p class="small">1.6</p>
        </footer>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script>
            function getSeatInfo(c) {
                let Http = new XMLHttpRequest();
                let url = "https://api.umd.io/v1/courses/sections/"+c.classCode+"-"+c.section;
                var json;
                
                Http.onload = function () {
                    json = JSON.parse(Http.responseText);
                    
                    if (json != undefined) {
                        c.openSeats = parseInt(json[0].open_seats);
                        c.totalSeats = parseInt(json[0].seats);
                        c.takenSeats = c.totalSeats-c.openSeats;
                        c.percentFull = (c.takenSeats / c.totalSeats)*100.0;
                    } else {
                        console.log("json was unefined for url "+url)
                    }
                };
                
                Http.open("GET",url);
                Http.send(); 
            }
            
            class ScheduleClass {
                constructor(classCode, section) {
                  this.classCode = classCode;
                  this.section = section;
                }
            }
            
            ScheduleClass.prototype.toString = function ClassToString() {
              return `${this.classCode} ${this.section}`;
            }
            
            let classes = [];
            let table = document.getElementById("Spring2022").getElementsByClassName('ScheduleTable')[0];
            
            function updateTable() {
                let tabLen = table.rows.length;
                
                for (let i = 1; i < tabLen; i++){
                    table.deleteRow(1);
                }
                
                for (let j = 0; j < classes.length; j++) {    
                    getSeatInfo(classes[j]);
                    
                    var row = table.insertRow();
                    var cell0 = row.insertCell(0);
                    var cell1 = row.insertCell(1);
                    var cell2 = row.insertCell(2);
                    var cell3 = row.insertCell(3);
                    var cell4 = row.insertCell(4);
                    var cell5 = row.insertCell(5);
                    var cell6 = row.insertCell(6);
                    var cell7 = row.insertCell(7);

                    cell0.innerHTML = classes[j].classCode;
                    cell1.innerHTML = classes[j].section;
                    cell2.innerHTML = classes[j].totalSeats;
                    cell3.innerHTML = classes[j].openSeats;
                    cell4.innerHTML = classes[j].takenSeats;
                    cell5.innerHTML = Math.round(classes[j].percentFull*100)/100 +"%";
                    cell6.innerHTML = "<progress max="+classes[j].totalSeats+" value="+classes[j].takenSeats+"></progress>"
                    cell7.innerHTML = "<a href=\"#\" onclick=\"deleteClass("+(j+1)+")\">x</a>";
                }
            }
            
            function formSubmit() {
                let code = document.getElementById('classCodeInput').value;
                let sec = document.getElementById('sectionInput').value;
                
                if ((code == null || sec == null) || (code == "" || sec == "")) {
                    throw "Invalid Input!";
                }
                
                classes.push(new ScheduleClass(code,sec))
                updateTable();
                setTimeout(() => {  updateTable(); }, 10);
                
                storeCookie(classes,'classes');
            }
            
            function onLoad() {
                if (document.cookie == '' || document.cookie=='classes=') {
                    
                    let classes = [];
                    
                    updateTable();
                    setTimeout(() => {  updateTable(); }, 10);
                
                    storeCookie(classes,"classes");
                } else {
                    loadCookie(classes,"classes");
                }
                
                updateTable();
                setTimeout(() => {  updateTable(); }, 10);
            }
            
            function deleteClass(index) {
                classes.splice(index-1,1);
                updateTable();
                
                storeCookie(classes,"classes");
            }
            
            function storeCookie(a, name) {
                document.cookie = (name+"="+a.toString()+"; expires=05 May 2022 23:00:00 UTC; path=/");
            }
            
            function loadCookie(a,name) {
                cookArr = getCookie(name).split(',');
                
                for (let i = 0; i < cookArr.length; i++) {
                    sep = cookArr[i].split(" ");
                    a.push(new ScheduleClass(sep[0],sep[1]));
                }
            }
            
            function getCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ')
                        c = c.substring(1);
                    if (c.indexOf(nameEQ) != -1)
                        return c.substring(nameEQ.length, c.length);
                }
                return null;
            }
            
        </script>
    </body>
</html>